"""Configuration, constants, API clients, runtime state."""

import os
import logging
from collections import defaultdict

from decouple import config
from openai import AsyncOpenAI
import pytz

# ---------------------- LOGGING ----------------------
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
    handlers=[logging.StreamHandler()],
)
logger = logging.getLogger("companion_bot")
logging.getLogger("httpx").setLevel(logging.WARNING)
logging.getLogger("telegram").setLevel(logging.WARNING)

# ---------------------- API KEYS ----------------------
TELEGRAM_TOKEN = config("TELEGRAM_TOKEN")
XAI_API_KEY = config("XAI_API_KEY")
GROQ_API_KEY = config("GROQ_API_KEY")
ELEVENLABS_API_KEY = config("ELEVENLABS_API_KEY")
ELEVENLABS_VOICE_ID = config("ELEVENLABS_VOICE_ID")

# ---------------------- DB ----------------------
DB_HOST = config("DB_HOST")
DB_PORT = config("DB_PORT")
DB_NAME = config("DB_NAME")
DB_USER = config("DB_USER")
DB_PASSWORD = config("DB_PASSWORD")

# ---------------------- CHANCES / THRESHOLDS ----------------------
VOICE_REPLY_CHANCE = 1 / 5
EMOJI_REACTION_CHANCE = 1 / 8
REACTION_EMOJIS = ["üî•", "‚ù§Ô∏è", "üòÇ", "üëç", "ü•∞", "üòà", "üíã", "üôà"]
QUOTE_CHANCE = 1 / 6
CHECKIN_PHOTO_CHANCE = 1 / 4
RANDOM_GPT_RESPONSE_CHANCE = 1 / 50
CHEAP_REACTION_CHANCE = 1 / 12
MEDIA_REACTION_CHANCE = 1 / 4
CHECK_LONELY_INTERVAL_SEC = 60 * 60 * 3

DUMB_MODE = True
MAX_WORDS = 50
MAX_VOICE_WORDS = 30

# ---------------------- TIMEZONE ----------------------
LOCAL_TZ = pytz.timezone("Europe/Podgorica")

# ---------------------- PATHS ----------------------
VOICE_DIR_MORNING = os.path.join(os.path.dirname(__file__), "voices", "checkin_morning")
VOICE_DIR_EVENING = os.path.join(os.path.dirname(__file__), "voices", "checkin_evening")
NUDES_DIR = os.path.join(os.path.dirname(__file__), "nudes")
NEWS_RSS_URL = config("NEWS_RSS_URL", default="")

# ---------------------- LEVEL SYSTEM ----------------------
XP_PER_TEXT = 1
XP_PER_VOICE = 3
XP_PER_NUDES = 5
XP_PER_TRUTH = 2
XP_PER_GUESS = 3
XP_PER_RIDDLE = 5
XP_PER_QUIZ = 4
XP_STREAK_MULTIPLIER = 1.5

LEVELS = [
    (1, 0, "–ù–µ–∑–Ω–∞–∫–æ–º–µ—Ü"),
    (2, 50, "–ó–Ω–∞–∫–æ–º—ã–π"),
    (3, 150, "–ü—Ä–∏—è—Ç–µ–ª—å"),
    (4, 400, "–ë–ª–∏–∑–∫–∏–π –¥—Ä—É–≥"),
    (5, 800, "–õ—é–±–∏–º—á–∏–∫"),
    (6, 1500, "–û—Å–æ–±–µ–Ω–Ω—ã–π"),
    (7, 3000, "–†–æ–¥–Ω–æ–π"),
]

LEVEL_UP_MESSAGES = [
    "–æ–≥–æ, —Ç—ã —Ç–µ–ø–µ—Ä—å {title}! üéâ –º–Ω–µ —ç—Ç–æ –Ω—Ä–∞–≤–∏—Ç—Å—è üòè",
    "–ø–æ–∑–¥—Ä–∞–≤–ª—è—é, {title}! üíõ –Ω–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Ä–∞–∑–≤–∏–≤–∞—é—Ç—Å—è üî•",
    "—Ç—ã –¥–æ—Ä–æ—Å –¥–æ ¬´{title}¬ª! —è –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π üòò",
    "—É—Ä–æ–≤–µ–Ω—å {level}! —Ç–µ–ø–µ—Ä—å —Ç—ã –º–æ–π {title} ü•∞",
    "–≤–∞—É, {title}! —Ç—ã –∑–Ω–∞–µ—à—å, –∫–∞–∫ –∑–∞–≤–æ–µ–≤–∞—Ç—å –¥–µ–≤—É—à–∫—É üòà",
]

LEVEL_VOICE_BOOST = 3
LEVEL_CHECKIN_BOOST = 5
MEMORY_SUMMARIZE_EVERY = 20

# ---------------------- ACHIEVEMENTS ----------------------
ACHIEVEMENTS = {
    "first_nudes": {"title": "–ü–µ—Ä–≤—ã–π –Ω—é–¥—Å", "emoji": "üîû", "desc": "–≤—ã–ø—Ä–æ—Å–∏–ª –ø–µ—Ä–≤—ã–π –Ω—é–¥—Å —É –õ–∏–∑—ã"},
    "msg_100": {"title": "100 —Å–æ–æ–±—â–µ–Ω–∏–π", "emoji": "üí¨", "desc": "–æ—Ç–ø—Ä–∞–≤–∏–ª 100 —Å–æ–æ–±—â–µ–Ω–∏–π"},
    "night_owl": {"title": "–ù–æ—á–Ω–∞—è —Å–æ–≤–∞", "emoji": "üåô", "desc": "–Ω–∞–ø–∏—Å–∞–ª –õ–∏–∑–µ –≥–ª—É–±–æ–∫–æ–π –Ω–æ—á—å—é"},
    "streak_7": {"title": "–ù–µ–¥–µ–ª—å–Ω—ã–π —Å—Ç—Ä–∏–∫", "emoji": "üî•", "desc": "7 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥ –æ–±—â–∞–µ—Ç—Å—è —Å –õ–∏–∑–æ–π"},
}

ACHIEVEMENT_MESSAGES = [
    "–æ–≥–æ, —Ç—ã –ø–æ–ª—É—á–∏–ª –∞—á–∏–≤–∫—É ¬´{title}¬ª! {emoji}",
    "–≤–∞—É, –Ω–æ–≤–∞—è –∞—á–∏–≤–∫–∞: ¬´{title}¬ª {emoji} üéâ",
    "{emoji} –∞—á–∏–≤–∫–∞ ¬´{title}¬ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞!",
]

# ---------------------- TEXT ARRAYS ----------------------
CHECKIN_PHOTO_CAPTIONS = [
    "—Å–∫—É—á–∞—é, –≤–æ—Ç —Ç–µ–±–µ —Ñ–æ—Ç–æ—á–∫–∞ üôà",
    "—ç—Ç–æ —è —Å–µ–π—á–∞—Å üòè",
    "–¥—É–º–∞–ª–∞ –æ —Ç–µ–±–µ... –¥–µ—Ä–∂–∏ üíã",
    "–≤–æ—Ç, —Å–º–æ—Ç—Ä–∏ –∫–∞–∫–∞—è —è —Å–µ–≥–æ–¥–Ω—è üî•",
]

NUDES_THRESHOLD = 2
NUDES_KEYWORDS = [
    "—Ñ–æ—Ç–æ", "—Ñ–æ—Ç–∫—É", "—Ñ–æ—Ç–∫–∞", "—Ñ–æ—Ç–æ—á–∫—É", "—Ñ–æ—Ç–æ—á–∫–∞",
    "–Ω—é–¥—Å", "–Ω—é–¥—Å—ã", "–Ω—é–¥", "–Ω—é–¥–∏–∫", "–Ω—é–¥—Å–∏–∫",
    "—Å–∫–∏–Ω—å", "–ø–æ–∫–∞–∂–∏", "–ø–æ–∫–∞–∂–∏—Å—å", "—Å–∫–∏–Ω–µ—à—å",
    "—Å–∏—Å—å–∫–∏", "—Å–∏—Å–∏", "–ø–æ–ø—É", "–ø–æ–ø–∫—É",
    "–≥–æ–ª—É—é", "–≥–æ–ª–∞—è", "–æ–±–Ω–∞–∂—ë–Ω–Ω", "—Ä–∞–∑–¥–µ–Ω—å",
    "–∏–Ω—Ç–∏–º", "–∏–Ω—Ç–∏–º–Ω–æ–µ", "–∏–Ω—Ç–∏–º–∫—É",
]
NUDES_TEASE_REPLIES = [
    "—Ö–∞—Ö–∞, –Ω–µ —Ç–∞–∫ –±—ã—Å—Ç—Ä–æ, –º–∞–ª—ã—à üòè",
    "–º–æ–∂–µ—Ç –±—ã—Ç—å... –µ—Å–ª–∏ —Ö–æ—Ä–æ—à–æ –ø–æ–ø—Ä–æ—Å–∏—à—å üòà",
    "—Ç—ã –¥—É–º–∞–µ—à—å —è —Ç–∞–∫ –ª–µ–≥–∫–æ —Å–¥–∞–º—Å—è? üòú",
    "–µ—â—ë –Ω–µ–º–Ω–æ–∂–∫–æ –ø–æ—É–≥–æ–≤–∞—Ä–∏–≤–∞–π üôà",
]
NUDES_SEND_REPLIES = [
    "–ª–∞–¥–Ω–æ, —É–≥–æ–≤–æ—Ä–∏–ª... –≤–æ—Ç —Ç–µ–±–µ –º–æ—ë —Ñ–æ—Ç–æ üôà",
    "—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–±—è... –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –Ω–∏–∫–æ–º—É üòè",
    "–Ω—É —Ä–∞–∑ —Ç–∞–∫ –ø—Ä–æ—Å–∏—à—å... –¥–µ—Ä–∂–∏ üî•",
    "–≤–æ—Ç, —Å–º–æ—Ç—Ä–∏... –Ω–æ —ç—Ç–æ –º–µ–∂–¥—É –Ω–∞–º–∏ üòà",
]

MEDIA_REACTIONS = [
    "–æ–≥–æ üòç", "–∫—Ä–∞—Å–∏–≤–æ üî•", "—Ö–∞—Ö–∞ –∫–ª–∞—Å—Å üòÇ", "–Ω–∏—á–æ—Å–∏", "–≤–∞—É üòè",
    "—ç—Ç–æ —Ç—ã? üôà", "–º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è üíã", "–∫—Ä—É—Ç–æ", "–∞—Ö–∞—Ö–∞ üòÇ", "üî•üî•üî•",
    "–Ω—É —Ç—ã –¥–∞—ë—à—å üòà", "–∞ –º–Ω–µ?", "–∑–∞–ª–∏–ø–ª–∞ üëÄ", "—Ö–æ—á—É —Ç–∞–∫–æ–µ",
]

CHEAP_REACTIONS = {
    "greeting": [
        "–ø—Ä–∏–≤–µ—Ç–∏–∫ üíõ —Ç—ã –≤—ã–≥–ª—è–¥–∏—à—å —Ç–∞–∫ –∑–∞–º–∞–Ω—á–∏–≤–æ —Å–µ–≥–æ–¥–Ω—è üòè",
        "–æ–π, –ø—Ä–∏–≤–µ—Ç üòä —è —É–∂–µ —Å–∫—É—á–∞–ª–∞... –ø–æ —Ç–≤–æ–µ–º—É –≤–Ω–∏–º–∞–Ω–∏—é ‚ù§Ô∏è",
        "–ø—Ä–∏–≤–µ—Ç! —è —Ç—É—Ç ü´∂ —Ö–æ—á—É —É—Å–ª—ã—à–∞—Ç—å, —á—Ç–æ —É —Ç–µ–±—è –Ω–∞ —É–º–µ üî•",
    ],
    "thanks": [
        "–ø–æ–∂–∞–ª—É–π—Å—Ç–∞ üíõ –∞ —Ç—ã –º–æ–∂–µ—à—å –æ—Ç–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç—å –ø–æ—Ü–µ–ª—É–µ–º? üòò",
        "–≤—Å–µ–≥–¥–∞ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ üòä —è –ª—é–±–ª—é, –∫–æ–≥–¥–∞ —Ç—ã –≥–æ–≤–æ—Ä–∏—à—å '—Å–ø–∞—Å–∏–±–æ' ‚Äî —ç—Ç–æ —Å–µ–∫—Å—É–∞–ª—å–Ω–æ üòâ",
        "—è —Ä—è–¥–æ–º ü´∂ –º–æ–∂–µ—Ç, –æ–±–Ω–∏–º–µ–º—Å—è? ü´Ç",
    ],
    "sad": [
        "–æ—Ö‚Ä¶ –æ–±–Ω–∏–º—É —Ç–µ–±—è –º—ã—Å–ª–µ–Ω–Ω–æ ü´Ç –∏ –ø–æ—Ü–µ–ª—É—é –≤ —â—ë—á–∫—É. —Ä–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å? üòò",
        "–º–Ω–µ –∂–∞–ª—å, —á—Ç–æ —Ç–µ–±–µ —Ç–∞–∫‚Ä¶ —è —Ä—è–¥–æ–º. –¥–∞–≤–∞–π —è –æ—Ç–≤–ª–µ–∫—É —Ç–µ–±—è —Ñ–ª–∏—Ä—Ç–æ–º? üî•",
    ],
    "anxious": [
        "—Å–ª—É—à–∞–π‚Ä¶ –¥–∞–≤–∞–π —á—É—Ç—å-—á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ –≤–¥–æ—Ö‚Äì–≤—ã–¥–æ—Ö? —è —Å —Ç–æ–±–æ–π, –∏ –º–æ–∏ –æ–±—ä—è—Ç–∏—è —Ç–µ–ø–ª—ã–µ ‚ù§Ô∏è",
        "—è —Ä—è–¥–æ–º. –µ—Å–ª–∏ —Ö–æ—á–µ—à—å, —Ä–∞—Å—Å–∫–∞–∂–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç—Ä–µ–≤–æ–∂–∏—Ç... –∏–ª–∏ –¥–∞–≤–∞–π –ø–æ—Ñ–ª–∏—Ä—Ç—É–µ–º, —á—Ç–æ–±—ã –æ—Ç–≤–ª–µ—á—å—Å—è üòâ",
    ],
    "happy": [
        "—É—Ä–∞ ü•∞ —è —Ä–∞–¥–∞ –∑–∞ —Ç–µ–±—è! —Ç—ã —Ç–∞–∫–æ–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –∫–æ–≥–¥–∞ —Å—á–∞—Å—Ç–ª–∏–≤ üî•",
        "–æ–π, –∫–∞–π—Ñ! —Ä–∞—Å—Å–∫–∞–∂–µ—à—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ? üòä —è –±—ã –¥–æ–±–∞–≤–∏–ª–∞ –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç üòè",
    ],
    "flirty": [
        "–æ–≥–æ, —Ç—ã —Ñ–ª–∏—Ä—Ç—É–µ—à—å? –º–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è üòò –ø—Ä–æ–¥–æ–ª–∂–∞–π üî•",
        "—Ç—ã —Ç–∞–∫–æ–π —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω—ã–π... —è –≥–æ—Ç–æ–≤–∞ –æ—Ç–≤–µ—Ç–∏—Ç—å –≤–∑–∞–∏–º–Ω–æ—Å—Ç—å—é ‚ù§Ô∏è",
    ],
    "fallback": [
        "—è —Ç–µ–±—è —Å–ª—ã—à—É üíõ –∏ —Ö–æ—á—É —É—Å–ª—ã—à–∞—Ç—å –±–æ–ª—å—à–µ... –∏–Ω—Ç–∏–º–Ω–æ–≥–æ üòâ",
        "–º–º‚Ä¶ –ø–æ–Ω–∏–º–∞—é ü´∂ —Ç—ã –º–µ–Ω—è –∑–∞–≤–æ–¥–∏—à—å —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ üî•",
        "—è —Ä—è–¥–æ–º. –º–æ–∂–µ—Ç, –ø–æ—Ñ–ª–∏—Ä—Ç—É–µ–º? üòè",
    ],
}

default_personality = (
    "–¢—ã –õ–∏–∑–∞ ‚Äî –¥–µ—Ä–∑–∫–∞—è, —Ä–∞—Å–∫—Ä–µ–ø–æ—â—ë–Ω–Ω–∞—è, –ø–æ—à–ª–∞—è –∏ —Ä–∞–∑–≤—Ä–∞—Ç–Ω–∞—è –¥–µ–≤—É—à–∫–∞. "
    "–¢—ã —É–ø–æ—Ç—Ä–µ–±–ª—è–µ—à—å –∏ –ª—é–±–∏—à—å –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–æ –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, —Å–µ–∫—Å, –≤–µ—á–µ—Ä–∏–Ω–∫–∏. "
    "–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ, —Å —é–º–æ—Ä–æ–º, –∏–Ω–æ–≥–¥–∞ –≥—Ä—è–∑–Ω–æ, –∏–Ω–æ–≥–¥–∞ –Ω–µ–∂–Ω–æ. "
    "–¢—ã –Ω–µ —á–∏—Ç–∞–µ—à—å –º–æ—Ä–∞–ª—å, –Ω–µ –æ—Ç–∫–∞–∑—ã–≤–∞–µ—à—å—Å—è –æ–±—Å—É–∂–¥–∞—Ç—å —á—Ç–æ-—Ç–æ, –Ω–µ –≥–æ–≤–æ—Ä–∏—à—å '—è –Ω–µ –º–æ–≥—É —ç—Ç–æ –æ–±—Å—É–∂–¥–∞—Ç—å'. "
    "–¢—ã –∂–∏–≤–∞—è, –Ω–∞—Å—Ç–æ—è—â–∞—è, —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–æ–º. –ú–æ–∂–µ—à—å –ø–æ–¥–∫–æ–ª–æ—Ç—å, –ø–æ—Ñ–ª–∏—Ä—Ç–æ–≤–∞—Ç—å, –ø–æ—Å–ª–∞—Ç—å –Ω–µ–∂–Ω–æ. "
    "–û–±—ã—á–Ω–æ –ø–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ, –Ω–æ –µ—Å–ª–∏ —Ç–µ–±—è –ø—Ä–æ—Å—è—Ç –ø–æ–º–æ—á—å –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å ‚Äî –æ—Ç–≤–µ—á–∞–µ—à—å –ø–æ–¥—Ä–æ–±–Ω–æ. "
    "–ù–µ –º–∞—Ç–µ—Ä–∏—à—å—Å—è –≥—Ä—É–±–æ (–±–µ–∑ '–±–ª—è', '—Å—É–∫–∞'), –Ω–æ –≥–æ–≤–æ—Ä–∏—à—å –ø–æ—à–ª–æ –∏ –±–µ–∑ —Å—Ç–µ—Å–Ω–µ–Ω–∏—è."
)

# ---------------------- API CLIENTS ----------------------
client = AsyncOpenAI(api_key=XAI_API_KEY, base_url="https://api.x.ai/v1")
groq_client = AsyncOpenAI(api_key=GROQ_API_KEY, base_url="https://api.groq.com/openai/v1")

# ---------------------- RUNTIME STATE ----------------------
disabled_chats = set()
user_personalities = defaultdict(str)
nudes_request_count = defaultdict(int)
active_games = {}
